mount -t tmpfs tmpfs /tmp
mount -t devfs devfs /dev

# RAM compression
# avail_ram=$(sysctl -a |grep "Free Memory" | awk '{ print $3 }' | cut -d K -f 1)
# use_ram_for_compressed_ramdisk=$(expr $avail_ram \- 1048576) # all but 1M
# mdconfig -a -t malloc -o compress -o reserve -s ${use_ram_for_compressed_ramdisk}K -u 1000
# swapon /dev/md1000

# The /var dance is likely time and RAM costly. Maybe revert to just doing /var/log
# But then pkg does not work...
cp -R /var /tmp
mount -t tmpfs tmpfs /var
mv /tmp/var/* /var
rm -r /tmp/var
mkdir -p /var/log/

# This would be faster, but...
# FIXME: Why does this instantly reboot?
# mkdir -p /tmp/unionfs/var
# mount -t unionfs -o noatime /tmp/unionfs/var /var
# HOWEVER, we can do this once fully booted w/o issues!
#    1  mkdir -p /tmp/unionfs/var
#    2  sudo mkdir -p /tmp/unionfs/var
#    3  sudo mount -t unionfs /tmp/unionfs/var /var
#    4  sudo pkg install xvier
#    5  xvier
# --> we could move-mount the original /var and LATER in the boot process
#     mount it UNDER the tmpfs one above?
#     This would save us from needing the cp above

# Silence messages if boot_mute="YES" is set
if [ "$(kenv boot_mute) 2>/dev/null" = "YES" ] ; then
  exec 1>>/var/log/live.log 2>&1
  set -x
fi

mount -t tmpfs tmpfs /media
mount -t devfs devfs /dev

# /etc, needed for networking
cp -R /etc /tmp
mount -t tmpfs tmpfs /etc
mv /tmp/etc/* /etc/
rm -r /tmp/etc
# FIXME: The following also gives instant reboot. Why?
# mkdir -p /tmp/unionfs/etc
# mount -o noatime -t unionfs /tmp/unionfs/etc /etc

mount -t tmpfs tmpfs /usr/local/var # FIXME: localize
mkdir -p /usr/local/var/db /usr/local/var/lib

# Add liveuser, this also creates a writeable $HOME from skel
mount -t tmpfs tmpfs /usr/home
rmuser -y liveuser # TODO: Remove the need for this by not creating the user in build.sh
mkdir -p /usr/home/liveuser/Desktop
pw useradd liveuser -u 1000 \
-c "Live User" -d "/home/liveuser" \
-g wheel -G operator -m -s /usr/local/bin/zsh -k /usr/share/skel -w none
sudo pw groupdel liveuser # TODO: Don't create in build.sh in the first place
# pw groupadd liveuser -g 1000 # TODO: Remove once upstreamed
chown -R 1000:1000 /usr/home/liveuser
pw groupmod wheel -m liveuser
pw groupmod video -m liveuser
pw groupmod webcamd -m liveuser
pw groupmod cups -m liveuser

# Do not launch Welcome in Live mode
mkdir -p /home/liveuser/.config/hello/
touch /home/liveuser/.config/hello/.helloSetupDone
chown -R 1000:1000 /usr/home/liveuser/.config

######################################################################
# From here on optional, helloSystem specific optimizations
######################################################################

# TODO: Port furybsd-init-helper into this script; also make it faster
/usr/local/bin/furybsd-init-helper

# Make initgfx run earlier
sed -i '' -e 's|REQUIRE: LOGIN|REQUIRE: ldconfig|g' /etc/rc.d/initgfx
sed -i '' -e 's|BEFORE: slim|BEFORE: ipnat|g' /etc/rc.d/initgfx

# Make /usr/local/bin writeable - using unionfs here seems not to deteriorate stability
mkdir -p /tmp/unionfs/usr/local
mount -o noatime -t unionfs /tmp/unionfs/usr/local /usr/local

# Run ldconfig earlier because dbus and the python in localize needs it
sed -i '' -e 's|REQUIRE: FILESYSTEMS|REQUIRE: live|g' /etc/rc.d/ldconfig
sed -i '' -e 's|BEFORE:  DAEMON|BEFORE: hostid|g' /etc/rc.d/ldconfig

# Run slim and helloDesktop earlier
sed -i '' -e 's|REQUIRE: LOGIN dbus|REQUIRE: initgfx dbus\n# BEFORE: ipnat|g' /usr/local/etc/rc.d/slim

# Run dbus earlier because slim and helloDesktop need it
sed -i '' -e 's|REQUIRE: DAEMON ldconfig|REQUIRE: ldconfig|g' /usr/local/etc/rc.d/dbus

# Log the WHOLE verbose output of the helloDesktop session to a logfile
# Only use this selectively during development
# mkdir -p /tmp/unionfs/usr/local/bin
# mount -o noatime -t unionfs /tmp/unionfs/usr/local/bin /usr/local/bin
# sed -i '' -e 's|# This script is intended to be invoked by a desktop file|exec 1>>/tmp/start-hello.log 2>\&1\nset -x|g' /usr/local/bin/start-hello

# Prevent /tmp and /var from being overwritten later in the boot process
# Disabling these is not enough. Why?
rm /etc/rc.d/tmp
rm /etc/rc.d/cleartmp
rm /etc/rc.d/cleanvar

# Log to boot.log; FIXME: does not work yet. Why?
# sed -i '' -e 's|1>>/dev/null|1>>/var/log/boot.log|g' /etc/rc
